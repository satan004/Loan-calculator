{% extends "base.html" %}

{% block title %}Scientific Calculator{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="calculator1" style="color:#fff; max-width:650px; margin:32px auto; padding:22px; border-radius:12px;">
    <input type="text" id="display" class="calculator-display1" readonly value="0" style="background:#d8d8d8; color:#212121; border:none; height:64px; font-size:1.4rem;" aria-live="polite">

    <div style="display:flex; gap:12px; margin:12px 0; align-items:center;">
        <button class="calculator-button" style="width:65px;"id="angleToggle" onclick="toggleAngleMode()">Deg</button>
        <button class="calculator-button" style="width:65px;"onclick="toggleAns()">Ans</button>
        <button class="calculator-button" style="width:65px;"onclick="clearDisplay()">AC</button>
        <button class="calculator-button" style="width:65px;" onclick="backspace()">⌫</button>
        <div style="flex:1"></div>
        <button class="calculator-button equals" style="width:142px;" onclick="calculate()">=</button>
    </div>

    <div class="calculator-buttons" style="grid-template-columns: repeat(8, 1fr); gap:12px;">
        <!-- Row: parentheses, comma, constants, 7,8,9, divide -->
        <button class="calculator-button" onclick="appendToDisplay('(')">(</button>
        <button class="calculator-button" onclick="appendToDisplay(')')">)</button>
        <button class="calculator-button" onclick="appendToDisplay(',')"> , </button>
        <button class="calculator-button" onclick="insertConstant('e')">e</button>
        <button class="calculator-button" onclick="appendToDisplay('1')">1</button>
        <button class="calculator-button" onclick="appendToDisplay('2')">2</button>
        <button class="calculator-button" onclick="appendToDisplay('3')">3</button>
        <button class="calculator-button operator" onclick="appendToDisplay('/')">÷</button>

        <!-- Row: pi, log, x^2, sqrt, 4,5,6, multiply -->
        <button class="calculator-button" onclick="insertConstant('pi')">π</button>
        <button class="calculator-button" onclick="applyUnary('log')">log</button>
        <button class="calculator-button" onclick="applyUnary('sqr')">x²</button>
        <button class="calculator-button" onclick="applyUnary('sqrt')">√</button>
        <button class="calculator-button" onclick="appendToDisplay('4')">4</button>
        <button class="calculator-button" onclick="appendToDisplay('5')">5</button>
        <button class="calculator-button" onclick="appendToDisplay('6')">6</button>
        <button class="calculator-button operator" onclick="appendToDisplay('*')">×</button>

        <!-- Row: x^3, root, x^n, nthroot, 1,2,3, minus -->
        <button class="calculator-button" onclick="applyUnary('cube')">x³</button>
        <button class="calculator-button" onclick="applyUnary('cuberoot')">∛</button>
        <button class="calculator-button" onclick="powerPrompt()">x^n</button>
        <button class="calculator-button" onclick="nthRootPrompt()">√n</button>
        <button class="calculator-button" onclick="appendToDisplay('7')">7</button>
        <button class="calculator-button" onclick="appendToDisplay('8')">8</button>
        <button class="calculator-button" onclick="appendToDisplay('9')">9</button>
        <button class="calculator-button operator" onclick="appendToDisplay('-')">-</button>

        <!-- Row: sin cos tan, 10^x, %, 0, ., plus -->
        <button class="calculator-button" onclick="applyUnary('sin')">sin</button>
        <button class="calculator-button" onclick="applyUnary('cos')">cos</button>
        <button class="calculator-button" onclick="applyUnary('tan')">tan</button>
        <button class="calculator-button" onclick="applyUnary('exp10')">10^x</button>
        <button class="calculator-button" onclick="percent()">%</button>
        <button class="calculator-button" onclick="appendToDisplay('0')">0</button>
        <button class="calculator-button" onclick="appendToDisplay('.')">.</button>
        <button class="calculator-button operator" onclick="appendToDisplay('+')">+</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="../static/css/style.css">
<script src="../static/js/script.js"></script>
<script>
// Scientific calculator client-side logic
let angleMode = 'Deg'; // or 'Rad'
let lastAns = 0;

function toggleAngleMode(){
    angleMode = angleMode === 'Deg' ? 'Rad' : 'Deg';
    document.getElementById('angleToggle').textContent = angleMode;
}

function appendToDisplay(value){
    const d = document.getElementById('display');
    if (d.value === '0' && value !== '.') d.value = value;
    else d.value += value;
}

function clearDisplay(){
    document.getElementById('display').value = '0';
}

function backspace(){
    const d = document.getElementById('display');
    if (d.value.length <= 1) d.value = '0';
    else d.value = d.value.slice(0, -1);
}

function toggleAns(){
    appendToDisplay(lastAns.toString());
}

function insertConstant(name){
    if (name === 'pi') appendToDisplay(Math.PI.toFixed(8));
    if (name === 'e') appendToDisplay(Math.E.toFixed(8));
}

function percent(){
    // Convert last number to percent
    const d = document.getElementById('display');
    d.value = d.value.replace(/(\d+\.?\d*)$/,(m)=> (parseFloat(m)/100).toString());
}

function applyUnary(op){
    const d = document.getElementById('display');
    let x = parseFloat(d.value);
    try{
        let res = x;
        if (op === 'sin') res = angleMode==='Deg' ? Math.sin(x * Math.PI/180) : Math.sin(x);
        else if (op === 'cos') res = angleMode==='Deg' ? Math.cos(x * Math.PI/180) : Math.cos(x);
        else if (op === 'tan') res = angleMode==='Deg' ? Math.tan(x * Math.PI/180) : Math.tan(x);
        else if (op === 'sqrt') res = Math.sqrt(x);
        else if (op === 'sqr') res = x * x;
        else if (op === 'cube') res = Math.pow(x,3);
        else if (op === 'cuberoot') res = Math.cbrt(x);
        else if (op === 'log') res = Math.log10(x);
        else if (op === 'exp10') res = Math.pow(10, x);
        else res = x;
        if (isNaN(res) || !isFinite(res)) throw new Error('Invalid result');
        d.value = String(res);
        lastAns = res;
    // save to server history (single input)
    sendSave(`${op}(${x})`, res, 'scientific', 1);
    } catch(e){
        d.value = 'Error';
        setTimeout(()=> d.value='0', 1200);
    }
}

function powerPrompt(){
    const d = document.getElementById('display');
    const base = parseFloat(d.value);
    const p = prompt('Enter power (exponent):', '2');
    if (p === null) return;
    const res = Math.pow(base, parseFloat(p));
    d.value = String(res);
    lastAns = res;
    sendSave(`${base}^${p}`, res, 'scientific', 2);
}

function nthRootPrompt(){
    const d = document.getElementById('display');
    const val = parseFloat(d.value);
    const n = prompt('Enter root degree (n):', '2');
    if (n === null) return;
    const res = Math.pow(val, 1/parseFloat(n));
    d.value = String(res);
    lastAns = res;
    sendSave(`root(${n},${val})`, res, 'scientific', 2);
}

function calculate(){
    const d = document.getElementById('display');
    let expr = d.value.replace(/×/g,'*').replace(/÷/g,'/');
    // allow ^ as exponent by replacing ^ with **
    expr = expr.replace(/\^/g,'**');
    try{
        // evaluate using Function
        const result = Function('return ('+expr+')')();
        d.value = String(result);
        lastAns = result;
    // compute inputs count from numeric tokens in expression
    const nums = (expr.match(/(\d+\.?\d*)/g) || []).length;
    sendSave(expr, result, 'scientific', nums);
    } catch(e){
        d.value = 'Error';
        setTimeout(()=> d.value='0', 1200);
    }
}

function sendSave(expression, result, type='scientific', inputs_count=null){
    try{
        if (inputs_count === null){
            inputs_count = (String(expression).match(/(\d+\.?\d*)/g) || []).length;
        }
        fetch('/api/save', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ expression: expression, result: result, type: type, inputs_count: inputs_count })
        });
    }catch(e){
        // ignore save errors
    }
}

// keyboard support (basic)
document.addEventListener('keydown', (ev)=>{
    const key = ev.key;
    if (/^[0-9]$/.test(key) || ['+','-','*','/','.','(',')','%'].includes(key)){
        ev.preventDefault(); appendToDisplay(key);
    } else if (key === 'Enter') { ev.preventDefault(); calculate(); }
    else if (key === 'Backspace'){ ev.preventDefault(); backspace(); }
    else if (key === 'Escape'){ ev.preventDefault(); clearDisplay(); }
});
</script>
{% endblock %}
